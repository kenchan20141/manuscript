<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中文寫作原稿紙</title>
    <style>
        body {
            font-family: 'KaiTi', serif; /* 使用楷體提升美觀性 */
            overflow-y: scroll; /* 確保頁面可上下滾動 */
            margin: 0;
            padding: 10px;
            background-color: #f9f9f9; /* 淺灰背景 */
        }
        h1 {
            text-align: center;
            font-size: 24px;
            margin-bottom: 20px;
            color: #333;
        }
        .page {
            display: grid;
            grid-template-columns: repeat(20, 1fr); /* 每行20格 */
            gap: 2px; /* 行間窄小空行 */
            margin-bottom: 20px;
            background-color: #fff;
            padding: 10px;
            border: 1px solid #ddd; /* 頁面邊框 */
            border-radius: 5px;
        }
        .cell {
            width: 20px;
            height: 20px; /* 保持正方形 */
            border: 1px solid #ccc; /* 方格邊框 */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            box-sizing: border-box;
            background-color: #fff;
        }
        /* 手機適配 */
        @media (max-width: 600px) {
            .cell {
                width: 15px;
                height: 15px;
                font-size: 12px;
            }
            h1 {
                font-size: 20px;
            }
        }
        #controls {
            text-align: center;
            margin-bottom: 20px;
        }
        #controls button {
            margin: 5px;
            padding: 8px 12px;
            font-size: 14px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        /* 第一組按鈕（綠色） */
        #save, #clear, #add-page {
            background-color: #4CAF50;
            color: white;
        }
        /* 第二組按鈕（藍色） */
        #export-pdf, #export-text {
            background-color: #008CBA;
            color: white;
        }
        #word-count {
            text-align: center;
            font-size: 16px;
            color: #666;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>中文寫作</h1>
    <div id="pages"></div>
    <div id="controls">
        <div>
            <button id="add-page">新增頁面</button>
            <button id="save">儲存</button>
            <button id="clear">清空</button>
        </div>
        <div>
            <button id="export-pdf">導出PDF</button>
            <button id="export-text">導出文字</button>
        </div>
    </div>
    <div id="word-count">字數：0</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script>
        // 創建原稿紙頁面
        function createPage(pageNum) {
            const page = document.createElement('div');
            page.className = 'page';
            const rows = pageNum % 2 === 1 ? 15 : 20; // 單數頁15行，偶數頁20行
            for (let i = 0; i < rows * 20; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.contentEditable = true;
                cell.addEventListener('input', handleInput);
                cell.addEventListener('keydown', handleKeydown);
                page.appendChild(cell);
            }
            return page;
        }

        // 處理輸入事件
        function handleInput(e) {
            const cell = e.target;
            if (cell.textContent.length > 1) {
                cell.textContent = cell.textContent[0]; // 限制每個格子一個字
            }
            const nextCell = cell.nextElementSibling;
            if (nextCell) {
                nextCell.focus();
            } else {
                const nextPage = cell.parentElement.nextElementSibling;
                if (nextPage) {
                    nextPage.firstElementChild.focus();
                }
            }
            updateWordCount();
        }

        // 處理刪除鍵
        function handleKeydown(e) {
            if (e.key === 'Backspace' && e.target.textContent === '') {
                const prevCell = e.target.previousElementSibling;
                if (prevCell) {
                    prevCell.textContent = '';
                    prevCell.focus();
                    updateWordCount();
                }
            }
        }

        // 更新字數統計
        function updateWordCount() {
            const pages = document.getElementById('pages');
            let count = 0;
            Array.from(pages.children).forEach(page => {
                Array.from(page.children).forEach(cell => {
                    if (cell.textContent.trim() !== '') count++;
                });
            });
            document.getElementById('word-count').textContent = `字數：${count}`;
        }

        // 新增頁面
        document.getElementById('add-page').addEventListener('click', () => {
            const pages = document.getElementById('pages');
            const pageNum = pages.children.length + 1;
            const newPage = createPage(pageNum);
            pages.appendChild(newPage);
            window.scrollTo(0, document.body.scrollHeight); // 滾動到最新頁面
        });

        // 儲存文章
        document.getElementById('save').addEventListener('click', () => {
            const pages = document.getElementById('pages');
            const data = [];
            Array.from(pages.children).forEach(page => {
                const pageData = [];
                Array.from(page.children).forEach(cell => {
                    pageData.push(cell.textContent);
                });
                data.push(pageData);
            });
            localStorage.setItem('manuscript', JSON.stringify(data));
            alert('已儲存');
        });

        // 清空文章
        document.getElementById('clear').addEventListener('click', () => {
            if (confirm('確定要清空所有文字嗎？')) {
                const pages = document.getElementById('pages');
                Array.from(pages.children).forEach(page => {
                    Array.from(page.children).forEach(cell => {
                        cell.textContent = '';
                    });
                });
                updateWordCount();
            }
        });

        // 導出PDF
        document.getElementById('export-pdf').addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pages = document.getElementById('pages');
            let y = 10;
            Array.from(pages.children).forEach((page, pageIndex) => {
                if (pageIndex > 0) {
                    doc.addPage();
                    y = 10;
                }
                doc.setFont('KaiTi', 'normal'); // 設置楷體字型（需自行引入）
                const rows = pageIndex % 2 === 0 ? 15 : 20;
                for (let i = 0; i < rows; i++) {
                    let line = '';
                    for (let j = 0; j < 20; j++) {
                        const cell = page.children[i * 20 + j];
                        line += cell.textContent || ' ';
                    }
                    doc.text(line, 10, y);
                    y += 10;
                }
            });
            doc.save('manuscript.pdf');
        });

        // 導出文字
        document.getElementById('export-text').addEventListener('click', () => {
            const pages = document.getElementById('pages');
            let text = '';
            Array.from(pages.children).forEach(page => {
                const rows = page.children.length / 20;
                for (let i = 0; i < rows; i++) {
                    let line = '';
                    for (let j = 0; j < 20; j++) {
                        const cell = page.children[i * 20 + j];
                        line += cell.textContent || '';
                    }
                    text += line.trim() + '\n';
                }
                text += '\n';
            });
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'manuscript.txt';
            a.click();
            URL.revokeObjectURL(url);
        });

        // 初始化頁面並載入儲存的文章
        window.addEventListener('load', () => {
            const pages = document.getElementById('pages');
            const firstPage = createPage(1);
            pages.appendChild(firstPage);
            const savedData = localStorage.getItem('manuscript');
            if (savedData) {
                const data = JSON.parse(savedData);
                data.forEach((pageData, pageIndex) => {
                    if (pageIndex > 0) {
                        const newPage = createPage(pageIndex + 1);
                        pages.appendChild(newPage);
                    }
                    const page = pages.children[pageIndex];
                    pageData.forEach((text, cellIndex) => {
                        page.children[cellIndex].textContent = text;
                    });
                });
                updateWordCount();
            }
        });
    </script>
</body>
</html>
